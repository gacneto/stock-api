<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Estoque</title>
    <style>
        :root {
            --primary-color: #007bff;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --border-color: #dee2e6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); padding: 20px; max-width: 900px; margin: 2rem auto; color: var(--dark-gray); }
        h1, h2 { text-align: center; color: var(--dark-gray); }
        #app-container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        form { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; }
        input, textarea { padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; color: white; }
        .btn-create { background-color: var(--primary-color); }
        .btn-update { background-color: var(--success-color); }
        .btn-delete { background-color: var(--danger-color); font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        .btn-edit { background-color: #6c757d; font-size: 0.8rem; padding: 0.4rem 0.8rem; margin-right: 5px;}
        #products-list { list-style: none; padding: 0; }
        .product { display: flex; justify-content: space-between; align-items: center; background: #fff; margin-bottom: 12px; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); transition: box-shadow 0.2s; }
        .product:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .product-info h3 { margin: 0; color: var(--primary-color); }
        .product-info p { margin: 5px 0 0; color: #555; }
        #status { text-align: center; font-size: 1.2em; padding: 20px; color: #555;}
        #edit-form-container { background-color: #fff; padding: 2rem; margin-top: 2rem; border-radius: 8px; border: 1px solid var(--primary-color); }
    </style>
</head>
<body>
    <div id="app-container">
        <h1>Gerenciador de Estoque</h1>

        <form id="create-form">
            <h2>Adicionar Novo Produto</h2>
            <input type="text" id="name" placeholder="Nome do Produto" required>
            <textarea id="description" placeholder="Descrição"></textarea>
            <input type="number" id="price" placeholder="Preço (ex: 29.99)" step="0.01" required>
            <input type="number" id="stock" placeholder="Estoque" required>
            <button type="submit" class="btn btn-create">Adicionar Produto</button>
        </form>

        <div id="edit-form-container" style="display: none;">
            <h2>Editar Produto</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="text" id="edit-name" placeholder="Nome do Produto" required>
                <textarea id="edit-description" placeholder="Descrição"></textarea>
                <input type="number" id="edit-price" placeholder="Preço" step="0.01" required>
                <input type="number" id="edit-stock" placeholder="Estoque" required>
                <button type="submit" class="btn btn-update">Salvar Alterações</button>
            </form>
        </div>

        <h2>Produtos Cadastrados</h2>
        <p id="status">Carregando produtos...</p>
        <ul id="products-list"></ul>
    </div>

    <script>
        // ===================================================================
        // CONFIGURAÇÃO
        // ===================================================================
        const apiUrl = 'https://my-stock-api-2xg6.onrender.com/products'; 

        // Referências aos elementos do DOM
        const productList = document.getElementById('products-list');
        const statusText = document.getElementById('status');
        const createForm = document.getElementById('create-form');
        const editFormContainer = document.getElementById('edit-form-container');
        const editForm = document.getElementById('edit-form');

        // ===================================================================
        // FUNÇÕES DO CRUD
        // ===================================================================

        /**
         * READ: Busca todos os produtos e os exibe na tela
         */
        async function fetchProducts() {
            statusText.innerText = 'Carregando produtos...';
            statusText.style.display = 'block';
            productList.innerHTML = '';
            try {
                const response = await fetch(apiUrl);
                const products = await response.json();
                
                statusText.style.display = 'none';

                if (products.length === 0) {
                    statusText.innerText = 'Nenhum produto cadastrado.';
                    statusText.style.display = 'block';
                }

                products.forEach(product => {
                    const listItem = document.createElement('li');
                    listItem.className = 'product';
                    listItem.innerHTML = `
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <p>Preço: R$ ${parseFloat(product.price).toFixed(2)} | Estoque: ${product.stock}</p>
                        </div>
                        <div class="product-actions">
                            <button class="btn btn-edit" onclick='showEditForm(${JSON.stringify(product)})'>Editar</button>
                            <button class="btn btn-delete" onclick='handleDelete("${product.id}")'>Deletar</button>
                        </div>
                    `;
                    productList.appendChild(listItem);
                });
            } catch (error) {
                statusText.innerText = 'Falha ao carregar produtos.';
                console.error('Erro (READ):', error);
            }
        }

        /**
         * CREATE: Adiciona um novo produto
         */
        createForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Impede o recarregamento da página
            const newProduct = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
            };

            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newProduct),
                });
                createForm.reset(); // Limpa o formulário
                fetchProducts(); // Atualiza a lista de produtos
            } catch (error) {
                console.error('Erro (CREATE):', error);
                alert('Falha ao criar produto.');
            }
        });

        /**
         * UPDATE: Mostra o formulário de edição com os dados do produto
         */
        function showEditForm(product) {
            editFormContainer.style.display = 'block';
            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-name').value = product.name;
            document.getElementById('edit-description').value = product.description;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-stock').value = product.stock;
        }

        /**
         * UPDATE: Salva as alterações do produto
         */
        editForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = document.getElementById('edit-id').value;
            const updatedProduct = {
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-description').value,
                price: parseFloat(document.getElementById('edit-price').value),
                stock: parseInt(document.getElementById('edit-stock').value),
            };

            try {
                await fetch(`${apiUrl}/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedProduct),
                });
                editFormContainer.style.display = 'none'; // Esconde o formulário
                fetchProducts(); // Atualiza a lista
            } catch (error) {
                console.error('Erro (UPDATE):', error);
                alert('Falha ao atualizar produto.');
            }
        });

        /**
         * DELETE: Deleta um produto
         */
        async function handleDelete(id) {
            // Pede confirmação antes de deletar
            if (!confirm('Tem certeza que deseja deletar este produto?')) {
                return;
            }

            try {
                await fetch(`${apiUrl}/${id}`, {
                    method: 'DELETE',
                });
                fetchProducts(); // Atualiza a lista
            } catch (error) {
                console.error('Erro (DELETE):', error);
                alert('Falha ao deletar produto.');
            }
        }

        // ===================================================================
        // INICIALIZAÇÃO
        // ===================================================================
        fetchProducts(); // Busca os produtos quando a página carrega
    </script>
</body>
</html>