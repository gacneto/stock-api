<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Estoque v2</title>
    <style>
        :root { --primary-color: #007bff; --danger-color: #dc3545; --light-gray: #f8f9fa; --dark-gray: #343a40; --border-color: #dee2e6; }
        body { font-family: sans-serif; background-color: var(--light-gray); margin: 0; }
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--dark-gray); }
        form { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 2rem; }
        input, textarea, button { padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        button { cursor: pointer; color: white; border: none; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-danger { background-color: var(--danger-color); }
        .product-actions button, .user-actions button { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        #products-list, #user-list { list-style: none; padding: 0; }
        .product, .user { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .item-info h3 { margin: 0; color: var(--primary-color); }
        .item-info p { margin: 5px 0 0; color: #555; }
        #auth-section { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--dark-gray); color: white; }
        #user-info { font-weight: bold; }
        #login-form { border-bottom: none; padding-bottom: 0; }
    </style>
</head>
<body>

    <div id="auth-section">
        <div id="user-info">Visitante</div>
        <button id="logout-button" class="btn-danger" style="display: none;">Logout</button>
    </div>

    <div class="container">
        <div id="login-container">
            <h2>Login</h2>
            <form id="login-form">
                <input type="text" id="username" placeholder="Usuário" required>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </div>

        <div id="admin-product-controls" style="display: none;">
            <form id="create-form">
                <h2>Adicionar Novo Produto</h2>
                <input type="text" id="name" placeholder="Nome do Produto" required>
                <input type="number" id="price" placeholder="Preço" step="0.01" required>
                <input type="number" id="stock" placeholder="Estoque" required>
                <button type="submit" class="btn-primary">Adicionar Produto</button>
            </form>
        </div>

        <div id="admin-user-controls" style="display: none;">
            <h2>Gerenciamento de Usuários</h2>
            <ul id="user-list"></ul>
        </div>

        <h2>Produtos Cadastrados</h2>
        <p id="status">Carregando produtos...</p>
        <ul id="products-list"></ul>
    </div>

    <script>
        const apiUrl = 'https://sua-api.no-render.onrender.com'; // <-- COLOQUE SUA URL AQUI

        // Referências aos elementos do DOM
        const productList = document.getElementById('products-list');
        const userList = document.getElementById('user-list');
        const statusText = document.getElementById('status');
        const loginContainer = document.getElementById('login-container');
        const adminProductControls = document.getElementById('admin-product-controls');
        const adminUserControls = document.getElementById('admin-user-controls');
        const createForm = document.getElementById('create-form');
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');

        // Função para decodificar um JWT (simplificada)
        function decodeJwt(token) {
            try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
        }

        // Função principal para renderizar a UI baseada no estado de login
        function renderUI() {
            const token = localStorage.getItem('token');
            if (token) {
                const userData = decodeJwt(token);
                userInfo.innerText = `Logado como: ${userData.username} (Role: ${userData.role})`;
                loginContainer.style.display = 'none';
                logoutButton.style.display = 'block';

                if (userData.role === 'admin') {
                    adminProductControls.style.display = 'block';
                    adminUserControls.style.display = 'block';
                    fetchUsers(); // Busca usuários apenas se for admin
                } else {
                    adminProductControls.style.display = 'none';
                    adminUserControls.style.display = 'none';
                }
            } else {
                userInfo.innerText = 'Visitante';
                loginContainer.style.display = 'block';
                logoutButton.style.display = 'none';
                adminProductControls.style.display = 'none';
                adminUserControls.style.display = 'none';
            }
            fetchProducts();
        }

        // --- FUNÇÕES DE PRODUTOS ---
        async function fetchProducts() {
            // ... (função fetchProducts, como antes)
        }

        createForm.addEventListener('submit', async (e) => {
            // ... (função do createForm, como antes)
        });

        async function handleDeleteProduct(id) {
            // ... (função de deletar produto, como antes)
        }

        // --- FUNÇÕES DE USUÁRIOS (NOVAS!) ---
        async function fetchUsers() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`${apiUrl}/user`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await response.json();
                userList.innerHTML = ''; // Limpa a lista
                const currentUser = decodeJwt(token);

                users.forEach(user => {
                    const listItem = document.createElement('li');
                    listItem.className = 'user';
                    
                    let deleteButtonHtml = '';
                    // Impede que o admin delete a si mesmo
                    if (user.id !== currentUser.userId) {
                        deleteButtonHtml = `<button class="btn-danger" onclick='handleDeleteUser("${user.id}")'>Deletar</button>`;
                    }

                    listItem.innerHTML = `
                        <div class="item-info">
                            <h3>${user.username}</h3>
                            <p>Role: ${user.role}</p>
                        </div>
                        <div class="user-actions">
                            ${deleteButtonHtml}
                        </div>
                    `;
                    userList.appendChild(listItem);
                });
            } catch (error) {
                console.error("Erro ao buscar usuários:", error);
                userList.innerHTML = '<li>Falha ao carregar usuários.</li>';
            }
        }

        async function handleDeleteUser(id) {
            if (!confirm('Tem certeza que deseja deletar este USUÁRIO? A ação é permanente.')) return;
            const token = localStorage.getItem('token');
            try {
                await fetch(`${apiUrl}/user/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                fetchUsers(); // Atualiza a lista de usuários
            } catch (e) { alert('Falha ao deletar usuário.'); }
        }

        // --- FUNÇÕES DE AUTENTICAÇÃO ---
        loginForm.addEventListener('submit', async (e) => {
            // ... (função de login, como antes)
        });

        logoutButton.addEventListener('click', () => {
            // ... (função de logout, como antes)
        });

        // Inicializa a aplicação
        renderUI();
    </script>
</body>
</html>