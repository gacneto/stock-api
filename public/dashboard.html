<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Gerenciador de Estoque</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ESTILOS ESPECÍFICOS PARA TEXTAREA, IGUALANDO AOS INPUTS */
        textarea {
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical; /* Permite redimensionar verticalmente */
            min-height: 80px; /* Altura mínima para a textarea */
        }
        .edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .close-button {
            background: none;
            border: none;
            color: var(--dark-gray);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="auth-section">
        <div id="user-info"></div>
        <button id="logout-button" class="btn-danger">Logout</button>
    </div>

    <div class="container">
        <div id="admin-controls" style="display: none;">
            <form id="create-form">
                <h2>Adicionar Novo Produto</h2>
                <input type="text" id="name" placeholder="Nome do Produto" required>
                <textarea id="description" placeholder="Descrição (opcional)"></textarea>
                <input type="number" id="price" placeholder="Preço" step="0.01" required>
                <input type="number" id="stock" placeholder="Estoque" required>
                <button type="submit" class="btn-primary">Adicionar</button>
            </form>
        </div>

        <div id="edit-product-container" style="display: none;">
            <hr>
            <div class="edit-header">
                <h2>Editar Produto</h2>
                <button class="close-button" onclick="hideEditForm()">X</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <input type="text" id="edit-name" placeholder="Nome do Produto" required>
                <textarea id="edit-description" placeholder="Descrição"></textarea>
                <input type="number" id="edit-price" placeholder="Preço" step="0.01" required>
                <input type="number" id="edit-stock" placeholder="Estoque" required>
                <button type="submit" class="btn-primary">Salvar Alterações</button>
            </form>
            <hr>
        </div>

        <h2>Produtos Cadastrados</h2>
        <ul id="products-list" class="product-list"></ul>
    </div>

    <script>
        const apiUrl = 'https://my-stock-api-2xg6.onrender.com';
        const token = localStorage.getItem('token');

        // Referências aos elementos do DOM
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const adminControls = document.getElementById('admin-controls');
        const productList = document.getElementById('products-list');
        const createForm = document.getElementById('create-form');
        const editProductContainer = document.getElementById('edit-product-container');
        const editForm = document.getElementById('edit-form');

        // GUARDA DE ROTA: Verifica se o usuário está logado
        if (!token) {
            window.location.href = '/index.html';
        }

        function decodeJwt(token) { return JSON.parse(atob(token.split('.')[1])); }
        const userData = decodeJwt(token);

        // RENDERIZAÇÃO INICIAL DA UI
        function renderUI() {
            userInfo.innerText = `Logado como: ${userData.username} (Role: ${userData.role})`;
            if (userData.role === 'admin') {
                adminControls.style.display = 'block';
            }
            fetchProducts();
        }

        // FUNÇÃO DE LOGOUT
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/index.html';
        });

        // --- FUNÇÕES DE PRODUTOS (ATUALIZADAS) ---
        async function fetchProducts() {
            const response = await fetch(`${apiUrl}/products`);
            const products = await response.json();
            productList.innerHTML = '';
            products.forEach(product => {
                const listItem = document.createElement('li');
                listItem.className = 'product';
                let adminButtons = '';
                if (userData.role === 'admin') {
                    adminButtons = `
                        <div class="product-actions">
                            <button class="btn-primary" style="margin-right: 5px;" onclick='showEditForm(${JSON.stringify(product)})'>Editar</button>
                            <button class="btn-danger" onclick='handleDelete("${product.id}")'>Deletar</button>
                        </div>`;
                }
                listItem.innerHTML = `
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p>${product.description || 'Sem descrição'}</p>
                        <p><strong>Preço:</strong> R$ ${parseFloat(product.price).toFixed(2)} | <strong>Estoque:</strong> ${product.stock}</p>
                    </div>
                    ${adminButtons}
                `;
                productList.appendChild(listItem);
            });
        }

        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                price: parseFloat(document.getElementById('price').value),
                stock: parseInt(document.getElementById('stock').value),
            };
            // Adicionei uma validação simples para a descrição, caso venha vazia
            if (newProduct.description.trim() === '') {
                delete newProduct.description; // Remove o campo se estiver vazio para não enviar string vazia
            }

            try {
                const response = await fetch(`${apiUrl}/products`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(newProduct),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erro ao criar produto: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                alert('Falha ao se conectar com a API para criar produto.');
                console.error('Erro na criação:', error);
            }
            createForm.reset();
            fetchProducts();
        });

        async function handleDelete(id) {
            if (!confirm('Tem certeza que deseja deletar este PRODUTO? A ação é permanente.')) return;
            try {
                const response = await fetch(`${apiUrl}/products/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erro ao deletar produto: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                alert('Falha ao se conectar com a API para deletar produto.');
                console.error('Erro na exclusão:', error);
            }
            fetchProducts();
        }

        // --- FUNÇÕES DE EDIÇÃO (CORRIGIDAS E COM NOVO BOTÃO) ---
        function showEditForm(product) {
            editProductContainer.style.display = 'block';
            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-name').value = product.name;
            document.getElementById('edit-description').value = product.description || ''; // Garante string vazia, não 'null'
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-stock').value = product.stock;
            editProductContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function hideEditForm() {
            editProductContainer.style.display = 'none';
            editForm.reset(); // Limpa o formulário de edição
        }

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const updatedProductData = {
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-description').value,
                price: parseFloat(document.getElementById('edit-price').value),
                stock: parseInt(document.getElementById('edit-stock').value),
            };

            // Adicionei uma validação simples para a descrição, caso venha vazia
            if (updatedProductData.description.trim() === '') {
                updatedProductData.description = null; // Envia null para a API, para limpar a descrição
            }

            try {
                // CORREÇÃO AQUI: A URL da requisição PATCH estava faltando /products
                const response = await fetch(`${apiUrl}/products/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(updatedProductData),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    alert(`Erro ao atualizar produto: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                alert('Falha ao se conectar com a API para atualizar produto.');
                console.error('Erro na atualização:', error);
            }
            hideEditForm(); // Esconde o formulário usando a nova função
            fetchProducts(); // Atualiza a lista
        });

        // INICIA A PÁGINA
        renderUI();
    </script>
</body>
</html>